<!DOCTYPE html>
<html>

    <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Under the hood &mdash; AsyncDisplayKit</title>
    <meta name="description" content="Smooth asynchronous user interfaces for iOS apps.">

    <link rel="stylesheet" href="/AsyncDisplayKit/css/main.css">
    <link rel="canonical" href="http://facebook.github.io/AsyncDisplayKit/guide/5/">
</head>


    <body>

        <header class="site-header">

<div class="wrapper">

    <a class="site-title" href="/AsyncDisplayKit/">AsyncDisplayKit</a>

    <nav class="site-nav">
    <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
        <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
        <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
        <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
    </a>

    <div class="trigger">
        <a class="page-link page-link-active" href="/AsyncDisplayKit/guide">guide</a>
        <a class="page-link" href="https://github.com/facebook/AsyncDisplayKit">github</a>
    </div>
    </nav>

</div>

</header>


        <div class="page-content">
            <div class="wrapper">
                <div class="post">

    <header class="post-header">
    <h1 class="post-title">
        Under the hood
        <a class="edit-page-link" href="https://github.com/facebook/AsyncDisplayKit/tree/master/docs/guide/5-under-the-hood.md" target="_blank">[edit]</a>
    </h1>
    </header>

    <article class="post-content">
    <h2>Node architecture</h2>

<p><em>(Skip to the next section if you&#39;re not interested in AsyncDisplayKit implementation details.)</em></p>

<p>We&#39;ve described nodes as an abstraction over views and layers, and shown how to
interact with the underlying UIViews and CALayers when necessary.  Nodes don&#39;t
wrap or vend their UIKit counterparts, though &mdash; an ASImageNode&#39;s <code>.view</code>
is not a UIImageView!  So how do nodes work?</p>

<p><strong>NOTE:</strong>  Classes whose names begin with <code>_</code> are private.  Don&#39;t use them
directly!</p>

<p>Creating a node doesn&#39;t create its underlying view-layer pair.  This is why you
can create nodes cheaply and on background threads.  When you use a UIView or
CALayer property on a node, you&#39;re actually interacting with a proxy object,
<a href="https://github.com/facebook/AsyncDisplayKit/blob/master/AsyncDisplayKit/Private/_ASPendingState.h"><code>_ASPendingState</code></a>,
that&#39;s preconfigured to match UIView and CALayer defaults.</p>

<p>The first access to a node&#39;s <code>.view</code> or <code>.layer</code> property causes both to be
initialised and configured with the node&#39;s current state.  If it has subnodes,
they are recursively loaded as well.  Once a node has been loaded, the proxy
object is destroyed and the node becomes main-thread-affined &mdash; its
properties will update the underlying view directly.  (Layer-backed nodes do
the same, not loading views.)</p>

<p>Nodes are powered by
<a href="https://github.com/facebook/AsyncDisplayKit/blob/master/AsyncDisplayKit/Details/_ASDisplayLayer.h"><code>_ASDisplayLayer</code></a>
and
<a href="https://github.com/facebook/AsyncDisplayKit/blob/master/AsyncDisplayKit/Details/_ASDisplayView.h"><code>_ASDisplayView</code></a>.
These are lightweight to create and add to their respective hierarchies, and
provide integration points that allow nodes to act as full-fledged views or
layers.  It&#39;s possible to create nodes that are backed by custom view or layer
classes, but doing so is strongly discouraged as it disables the majority of
ASDK&#39;s functionality.  </p>

<p>When Core Animation asks an <code>_ASDisplayLayer</code> to draw itself, the request is
forwarded to its node.  Unless asynchronous display has been disabled, the
actual draw call won&#39;t happen immediately or on the main thread.  Instead, a
display block will be added to a background queue.  These blocks are executed
in parallel, but you can enable <code>ASDISPLAYNODE_DELAY_DISPLAY</code> in
<a href="https://github.com/facebook/AsyncDisplayKit/blob/master/AsyncDisplayKit/Private/ASDisplayNode%2BAsyncDisplay.mm"><code>ASDisplayNode(AsyncDisplay)</code></a>
to serialise the render system for debugging.</p>

<p>Common UIView subclass hooks are forwarded from <code>_ASDisplayView</code> to its
underlying node, including touch handling, hit-testing, and gesture recogniser
delegate calls.  Because an <code>_ASDisplayView</code>&#39;s layer is an <code>_ASDisplayLayer</code>,
view-backed nodes also participate in asynchronous display.</p>

<h2>In practice</h2>

<p>What does this mean for your custom nodes?</p>

<p>You can implement methods like <code>-touchesBegan::</code> / <code>Moved::</code> / <code>Ended::</code> /
<code>Cancelled::</code> in your nodes exactly as you would in a UIView subclass.  If you
find you need a subclass hook that hasn&#39;t already been provided, please file an
issue on GitHub &mdash; or add it yourself and submit a pull request!</p>

<p>If you need to interact or configure your node&#39;s underlying view or layer,
don&#39;t do so in <code>-init</code>.  Instead, override <code>-didLoad</code> and check if you&#39;re
layer-backed:</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">didLoad</span>
<span class="p">{</span>
  <span class="p">[</span><span class="nb">super</span> <span class="n">didLoad</span><span class="p">];</span>

  <span class="c1">// add a gesture recogniser, if we have a view to add it to</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">self</span><span class="p">.</span><span class="n">layerBacked</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">_gestureRecogniser</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">UITapGestureRecognizer</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithTarget</span><span class="p">:</span><span class="nb">self</span>
                                                         <span class="nl">action</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">_tap</span><span class="p">:)];</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2><em>fin.</em></h2>

<p>Thanks for reading!  If you have any questions, please file a GitHub issue or
post in the <a href="https://www.facebook.com/groups/551597518288687">Facebook group</a>.
We&#39;d love to hear from you.</p>

    </article>

    <div class="docs-prevnext">
        
        <a class="docs-prev" href="/AsyncDisplayKit/guide/4/">&larr; prev</a>
        
        
    </div>

</div>

            </div>
        </div>

        <footer class="site-footer">

<div class="wrapper">
    <div class="footer-col-wrapper">
        <div class="footer-col  footer-col-left">
            <p class="text">a Facebook &amp; Instagram collaboration &#x2665;</p>
        </div>

        <div class="footer-col  footer-col-right">
            <p class="text">
            &copy; 2014 Facebook Inc (<a href="/AsyncDisplayKit/license/">CC-BY-4.0</a>)
            </p>
        </div>
    </div>

</div>

</footer>


    </body>

</html>
